<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Overlay Animation</title>
  
  <!-- Preload fonts for immediate availability -->
  <link rel="preload" href="https://raw.githubusercontent.com/originmediastudio/overlaydemos/main/fonts/subset-TTRamillas-Light.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="https://raw.githubusercontent.com/originmediastudio/overlaydemos/main/fonts/subset-MacysSans-Bold.woff2" as="font" type="font/woff2" crossorigin>
  
  <style>
    /* Load subsetted fonts from GitHub */
    @font-face {
      font-family: 'TT Ramillas';
      src: url('https://raw.githubusercontent.com/originmediastudio/overlaydemos/main/fonts/subset-TTRamillas-Light.woff2') format('woff2');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Macys Sans';
      src: url('https://raw.githubusercontent.com/originmediastudio/overlaydemos/main/fonts/subset-MacysSans-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
      font-display: swap;
    }

    /* Reset and transparent background */
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Wrapper for all overlay elements */
    #textWrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Shared text styles */
    #text1, #text2 {
      position: absolute;
      left: 41.5%;
      color: #fff;
      text-align: center;
    }
    /* First line: no wrap, baseline anchor */
    #text1 {
      bottom: 75%;
      font-size: 5.5vw;
      white-space: nowrap;
      font-family: 'TT Ramillas', serif;
      letter-spacing: -0.05em;
      transform-origin: left bottom;
      margin-left: -0.3vw;
    }
    /* Second line wrap per word */
    #text2 {
      bottom: 69%;
      font-size: 2.3vw;
      white-space: pre-wrap;
      line-height: 1.2;
      font-family: 'Macys Sans', sans-serif;
      text-transform: uppercase;
    }

    /* Image mask styling (will be created dynamically) */
    .image-mask {
      position: absolute;
      overflow: hidden;
      opacity: 0;
      transform-origin: center center;
    }

    @keyframes slideFade {
      from { opacity: 0; transform: translateX(10px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    @keyframes appear {
      to { opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to   { opacity: 0; }
    }
    .char, .word {
      display: inline-block;
      opacity: 0;
    }
  </style>
</head>
<body>
  <div id="textWrapper">
    <div id="text1"></div>
    <div id="text2"></div>
  </div>

  <script>
    (function() {
      const fps = 24;
      const startFrame1 = 350;
      const startFrame2 = 365;
      const letterFrames = 18;
      const wordFrames = 28;
      const imageFrame = 391;
      const fadeStartFrame = 710;
      const fadeFrames = 8;

      let handshakeTime = 0;
      let handshakeVideoTime = 0;
      let campaignDataReceived = false;
      let receivedCampaignData = null;

      window.addEventListener('message', function(e) {
        if (e.data === 'parentLoaded') {
          parent.postMessage('overlayReady', '*');
        }
        if (e.data && e.data.type === 'init') {
          handshakeTime = performance.now();
          handshakeVideoTime = e.data.currentTime;
          if (campaignDataReceived) setupAnimations();
        }
        if (e.data && e.data.type === 'campaignData') {
          receivedCampaignData = e.data;
          campaignDataReceived = true;
          if (handshakeTime > 0) setupAnimations();
        }
      });

      function setupAnimations() {
        const now = performance.now();
        const videoTime = handshakeVideoTime + (now - handshakeTime) / 1000;

        const t1 = receivedCampaignData.text1 || "";
        const t2 = receivedCampaignData.text2 || "";

        const c1 = document.getElementById('text1');
        const c2 = document.getElementById('text2');
        c1.textContent = '';
        Array.from(t1).forEach((char, i) => {
          const span = document.createElement('span');
          span.className = 'char';
          span.textContent = char === ' ' ? '\u00A0' : char;
          span.style.animation = `slideFade ${letterFrames/fps}s ease-out forwards`;
          span.style.animationDelay = `${Math.max((startFrame1+i)/fps - videoTime,0)}s`;
          c1.appendChild(span);
        });
        // auto-scale if too wide (>55%)
        const wrapper = document.getElementById('textWrapper');
        const maxW = wrapper.clientWidth * 0.55;
        if (c1.offsetWidth > maxW) {
          c1.style.transform = `scale(${maxW/c1.offsetWidth})`;
        }

        c2.textContent = '';
        t2.split(' ').forEach((word,i,arr)=>{
          const span = document.createElement('span');
          span.className = 'word';
          span.textContent = word;
          span.style.animation = `slideFade ${wordFrames/fps}s ease-out forwards`;
          span.style.animationDelay = `${Math.max((startFrame2+i)/fps - videoTime,0)}s`;
          c2.appendChild(span);
          if (i < arr.length-1) c2.appendChild(document.createTextNode(' '));
        });

        // image insertion at specified frame
        ['image01','image02','image03','image04'].forEach((key,idx)=>{
          const name = receivedCampaignData[key];
          if (!name) return;
          const mask = document.createElement('div');
          mask.className = 'image-mask';
          // mask size relative to viewport
          mask.style.width = `${(425/1920)*100}vw`;
          mask.style.height = `${(590/1080)*100}vh`;
          mask.style.borderRadius = `${(70/1920)*100}vw`;
          // placeholder positions; adjust as needed
          const positions = ['10%','35%','60%','85%'];
          mask.style.left = positions[idx];
          mask.style.bottom = '30%';
          const img = document.createElement('img');
          img.src = `images/${name}`;
          img.style.width = `${(475/1920)*100}vw`;
          img.style.height = 'auto';
          mask.appendChild(img);
          const delay = Math.max((imageFrame/fps) - videoTime,0);
          mask.style.animation = `appear 0s step-end forwards`;
          mask.style.animationDelay = `${delay}s`;
          wrapper.appendChild(mask);
        });

        // fade out all at end
        const fadeDelay = (fadeStartFrame/fps) - videoTime;
        wrapper.style.animation = `fadeOut ${fadeFrames/fps}s ease-out forwards`;
        wrapper.style.animationDelay = `${Math.max(fadeDelay,0)}s`;
      }
    })();
  </script>
</body>
</html>
