
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SIMID Demo Player</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
video{width:80vw;max-width:1280px;background:#000;outline:none}
.controls{margin-top:8px;display:flex;gap:8px}
button{padding:6px 12px;font-size:16px;border:none;border-radius:4px;cursor:pointer}
iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;pointer-events:none}
</style>
</head>
<body>
<video id="vid" autoplay muted playsinline>
  <source src="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" type="application/x-mpegURL">
</video>

<div class="controls">
  <button id="toggleAudio">Toggle Audio</button>
</div>

<iframe id="overlay" title="SIMID Overlay" sandbox="allow-scripts allow-popups"></iframe>

<script>
(() => {
  const video = document.getElementById('vid');
  const iframe = document.getElementById('overlay');
  iframe.src = 'overlay-maine.html';

  const send = (obj) => iframe.contentWindow && iframe.contentWindow.postMessage(obj, '*');

  /* ---------- SIMID handshake ---------- */
  let handshakeDone = false;
  function sendPlayerInit() {
    send({
      type: 'playerInit',
      version: 'SIMID-1.1',
      environmentData: { deviceType: 'CTV' },
      creativeData: { adParameters: '{}' },
      verificationParameters: {}
    });
  }
  iframe.addEventListener('load', sendPlayerInit);

  window.addEventListener('message', (e) => {
    const { data } = e;
    if (!data || typeof data !== 'object') return;
    switch (data.type) {
      case 'creativeInit':
        if (data.success) {
          handshakeDone = true;
          send({ type: 'initAck', success: true });
        }
        break;
      case 'openUrl':
        window.open(data.url, '_blank');
        break;
    }
  });

  /* ---------- Playback updates ---------- */
  function startUpdates() {
    const loop = () => {
      if (handshakeDone) {
        send({ type: 'timeUpdate', currentTime: video.currentTime, duration: video.duration || 0 });
      }
      if (!video.paused && video.requestVideoFrameCallback) {
        video.requestVideoFrameCallback(loop);
      }
    };
    if (video.requestVideoFrameCallback) {
      video.requestVideoFrameCallback(loop);
    } else {
      setInterval(() => handshakeDone && send({ type: 'timeUpdate', currentTime: video.currentTime, duration: video.duration || 0 }), 250);
    }
  }

  video.addEventListener('play', () => { send({ type: 'resume' }); startUpdates(); });
  video.addEventListener('pause', () => send({ type: 'pause' }));
  video.addEventListener('volumechange', () => send({ type: 'volumeChange', volume: video.muted ? 0 : video.volume }));

  /* ---------- UI ---------- */
  document.getElementById('toggleAudio').addEventListener('click', () => {
    video.muted = !video.muted;
  });
})();
</script>
</body>
</html>
