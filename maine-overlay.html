<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Overlay Animation</title>
  <style>
    /* Reset and transparent background */
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Wrapper for both text lines */
    #textWrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Shared text styles */
    #text, #text2 {
      position: absolute;
      left: 16.67%;
      color: #fff;
      text-align: center;
      white-space: pre-wrap;
    }
    #text {
      top: 52%;
      font-size: 2.5vw;
      width: 20vw;
      margin-left: -10vw;
      font-family: 'SegoePro-Bold', sans-serif;
    }
    #text2 {
      top: 59%;
      font-size: 1.6vw;
      width: 20vw;
      line-height: 1.2;
      margin-left: -10vw;
      font-family: 'SegoePro', sans-serif;
    }

    @keyframes slideFade {
      from { opacity: 0; transform: translateX(10px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to   { opacity: 0; }
    }
    .char, .word {
      display: inline-block;
      opacity: 0;
    }
  </style>
</head>
<body>
  <div id="textWrapper">
    <div id="text"></div>
    <div id="text2"></div>
  </div>

  <script>
    (function() {
      const tsvUrl = 'https://script.google.com/macros/s/AKfycbx-aX3pCZJQHoT8TdqvBZNgoof-l-BTL4yvanfStQuayFJcVA0A88iBMxKw9KnfPbJg/exec';
      const startFrame1 = 76;
      const startFrame2 = 86;
      const letterFrames = 16;
      const wordFrames = 27;
      const fadeStartFrame = 260;
      const fadeFrames = 7;

      let handshakeTime = 0;
      let handshakeVideoTime = 0;

      window.addEventListener('message', function handler(e) {
        // Parent loaded: notify ready
        if (e.data === 'parentLoaded') {
          parent.postMessage('overlayReady', '*');
        }

        // Init data received
        if (e.data && e.data.type === 'init') {
          const { currentTime, fps } = e.data;
          handshakeTime = performance.now();
          handshakeVideoTime = currentTime;

          // Fetch data immediately
          fetch(tsvUrl)
            .then(r => r.text())
            .then(text => {
              // compute actual video time at this moment
              const now = performance.now();
              const delta = (now - handshakeTime) / 1000;
              const videoTime = handshakeVideoTime + delta;

              // parse TSV and pick random row
              const rows = text.trim().split('\n').map(r => r.split('\t'));
              rows.shift();
              const [t1, t2] = rows[Math.floor(Math.random() * rows.length)];

              // populate containers
              const c1 = document.getElementById('text');
              const c2 = document.getElementById('text2');
              c1.textContent = t1;
              c2.textContent = t2;

              // durations in seconds
              const letterDuration = letterFrames / fps;
              const wordDuration = wordFrames / fps;
              const fadeStart = fadeStartFrame / fps;
              const fadeDuration = fadeFrames / fps;

              // schedule character animation
              const chars = Array.from(t1);
              c1.textContent = '';
              chars.forEach((char, i) => {
                const span = document.createElement('span');
                span.className = 'char';
                span.textContent = char;
                const delay = (startFrame1 + i) / fps - videoTime;
                span.style.animation = `slideFade ${letterDuration}s ease-out forwards`;
                span.style.animationDelay = `${Math.max(delay, 0)}s`;
                c1.appendChild(span);
              });

              // schedule word animation
              c2.textContent = '';
              t2.split(' ').forEach((word, i, arr) => {
                const span = document.createElement('span');
                span.className = 'word';
                span.textContent = word;
                const delay = (startFrame2 + i) / fps - videoTime;
                span.style.animation = `slideFade ${wordDuration}s ease-out forwards`;
                span.style.animationDelay = `${Math.max(delay, 0)}s`;
                c2.appendChild(span);
                if (i < arr.length - 1) c2.appendChild(document.createTextNode(' '));
              });

              // schedule fade out
              const wrapper = document.getElementById('textWrapper');
              const fadeDelay = fadeStart - videoTime;
              wrapper.style.animation = `fadeOut ${fadeDuration}s ease-out forwards`;
              wrapper.style.animationDelay = `${Math.max(fadeDelay, 0)}s`;
            });

          window.removeEventListener('message', handler);
        }
      });
    })();
  </script>
</body>
</html>
